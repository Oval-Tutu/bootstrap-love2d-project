name: Build LÃ–VE ðŸ©·ðŸ’™

on:
  push:
    tags:
      - "v?[0-9]+.[0-9]+.[0-9]+*"
  workflow_dispatch:

env:
  BUILD_TYPE: ${{ fromJSON('["dev", "release"]')[startsWith(github.ref, 'refs/tags/v')] }}
  OUTPUT_FOLDER: ./builds
  PRODUCT_NAME: Game
  PRODUCT_ID: com.ovaltutu.game
  PRODUCT_DESC: A game made with LÃ–VE by Oval Tutu
  PRODUCT_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || '0.0.0' }}
  PRODUCT_COPYRIGHT: Copyright (c) 2024 Oval Tutu
  PRODUCT_COMPANY: Oval Tutu
  PRODUCT_WEBSITE: https://oval-tutu.com
  PRODUCT_UUID: 3e64d17c-8797-4382-921f-cf488b22073f

jobs:
  configure:
    runs-on: ubuntu-22.04
    outputs:
      build_num: ${{ steps.set_build_num.outputs.build_num }}
    steps:
      - name: Generate build number
        id: set_build_num
        run: echo "build_num=$(date +%y.%j.%H%M)" >> $GITHUB_OUTPUT

  build-love:
    runs-on: ubuntu-22.04
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}" "${{ env.BUILD_NUM }}"
      - name: Upload love package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_love
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}.love

  build-linux:
    runs-on: ubuntu-22.04
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}"
      - name: Create .png icon
        run: |
          sudo apt-get -y install imagemagick
          convert "resources/icon.png" -resize 256x256 "${{ env.OUTPUT_FOLDER }}/icon.png"
      - name: Build Linux packages
        id: build-packages
        uses: love-actions/love-actions-linux@v2
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}
          app-name: ${{ env.PRODUCT_NAME }}
          bundle-id: ${{ env.PRODUCT_ID }}
          description: ${{ env.PRODUCT_DESC }}
          icon-path: ${{ env.OUTPUT_FOLDER }}/icon.png
          version-string: ${{ env.PRODUCT_VERSION }}
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Linux_AppImage
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}.AppImage
      - name: Upload Deb
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Linux_deb
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}.deb

  build-windows:
    runs-on: windows-latest
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        shell: bash
        run: 7z a -tzip "${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love" ./game
      - name: Create .ico icon
        shell: bash
        run: magick "resources/icon.png" -define icon:auto-resize="256,128,96,64,48,32,16" "${{ env.OUTPUT_FOLDER }}/icon.ico"
      - name: Build Windows packages
        id: build-packages
        uses: love-actions/love-actions-windows@v1
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}
          app-id: ${{ env.PRODUCT_UUID }}
          icon-path: ${{ env.OUTPUT_FOLDER }}/icon.ico
          installer-languages: English.isl
          project-website: ${{ env.PRODUCT_WEBSITE }}
          #rc-path: ./.github/build/windows/${{ env.BUILD_TYPE }}/template.rc
      - name: Upload 32-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Windows_x86_zip
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_x86.zip
      - name: Upload 64-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Windows_x64_zip
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_x64.zip
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Windows_installer_exe
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-installer.exe

  build-android:
    runs-on: ubuntu-22.04
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}"
      - name: Create Android res/ folder
        run: |
          sudo apt-get install -y imagemagick
          mkdir -p ${{ env.OUTPUT_FOLDER }}/res/mipmap-{hdpi,mdpi,xhdpi,xxhdpi,xxxhdpi}
          mkdir -p ${{ env.OUTPUT_FOLDER }}/res/values
          convert ./resources/icon.png -resize 72x72 ${{ env.OUTPUT_FOLDER }}/res/mipmap-hdpi/ic_launcher.png
          convert ./resources/icon.png -resize 48x48 ${{ env.OUTPUT_FOLDER }}/res/mipmap-mdpi/ic_launcher.png
          convert ./resources/icon.png -resize 96x96 ${{ env.OUTPUT_FOLDER }}/res/mipmap-xhdpi/ic_launcher.png
          convert ./resources/icon.png -resize 144x144 ${{ env.OUTPUT_FOLDER }}/res/mipmap-xxhdpi/ic_launcher.png
          convert ./resources/icon.png -resize 192x192 ${{ env.OUTPUT_FOLDER }}/res/mipmap-xxxhdpi/ic_launcher.png
          echo '<resources><string name="app_name">${{ env.PRODUCT_NAME }}</string></resources>' > ${{ env.OUTPUT_FOLDER }}/res/values/strings.xml
      - name: Build Android packages
        id: build-packages
        uses: love-actions/love-actions-android@v2
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}
          app-name: ${{ env.PRODUCT_NAME }}
          bundle-id: ${{ env.PRODUCT_ID }}
          #icon-specifier: "@mipmap/icon"
          #keystore-alias: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          #keystore-base64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          #keystore-key-password: ${{ secrets.ANDROID_KEYSTORE_KEYPASSWORD }}
          #keystore-store-password: ${{ secrets.ANDROID_KEYSTORE_STOREPASSWORD }}
          resource-path: ${{ env.PRODUCT_RES }}
          version-string: ${{ env.PRODUCT_VERSION }}
          version-code: ${{ github.run_number }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_Android_release_apk
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-release.apk

  build-macos-portable:
    runs-on: macos-latest
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}"
      - name: Create macOS icon.icns
        run: |
          mkdir -p icon.iconset
          sips -z 16 16     ./resources/icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     ./resources/icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     ./resources/icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     ./resources/icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   ./resources/icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   ./resources/icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   ./resources/icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   ./resources/icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   ./resources/icon.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 ./resources/icon.png --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o ${{ env.OUTPUT_FOLDER }}/icon.icns
      - name: Build macOS packages
        id: build-packages
        uses: love-actions/love-actions-macos-portable@v1
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-portable
          #account-username: ${{ secrets.APPLE_ACCOUNT_USERNAME }}
          #account-password: ${{ secrets.APPLE_ACCOUNT_PASSWORD }}
          #team-id: "${{ secrets.APPLE_DEVELOPER_TEAM_ID }}"
          app-name: ${{ env.PRODUCT_NAME }}
          bundle-id: ${{ env.PRODUCT_ID }}
          copyright: ${{ env.PRODUCT_COPYRIGHT }}
          #developer-id-application-base64: ${{ secrets.APPLE_CERT_DEVELOPER_ID_APPLICATION }}
          #developer-id-application-password: ${{ secrets.APPLE_CERT_DEVELOPER_ID_APPLICATION_PWD }}
          #developer-id-installer-base64: ${{ secrets.APPLE_CERT_DEVELOPER_ID_INSTALLER }}
          #developer-id-installer-password: ${{ secrets.APPLE_CERT_DEVELOPER_ID_INSTALLER_PWD }}
          #dmg-background-path: ./.github/build/macOS/${{ env.BUILD_TYPE }}/dmg.png
          #dmg-icon-position: "239 203"
          #dmg-icon-size: "100"
          #dmg-link-position: "565 203"
          #dmg-text-size: "12"
          #dmg-volume-icon-path: ./.github/build/macOS/${{ env.BUILD_TYPE }}/dmg.icns
          dmg-volume-name: ${{ env.PRODUCT_NAME }}
          #dmg-window-position: "200 120"
          #dmg-window-size: "800 500"
          icon-path: ${{ env.OUTPUT_FOLDER }}/icon.icns
          version-string: ${{ env.PRODUCT_VERSION }}
      - name: Upload pkg artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_macOS_portable_pkg
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-portable.pkg
      - name: Upload dmg artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_macOS_portable_dmg
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-portable.dmg
      - name: Upload zip artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_macOS_portable_zip
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-portable.zip

  build-macos-appstore:
    runs-on: macos-latest
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}"
      - name: Create macOS icon.icns
        run: |
          mkdir -p icon.iconset
          sips -z 16 16     ./resources/icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     ./resources/icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     ./resources/icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     ./resources/icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   ./resources/icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   ./resources/icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   ./resources/icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   ./resources/icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   ./resources/icon.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 ./resources/icon.png --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o ${{ env.OUTPUT_FOLDER }}/icon.icns
      - name: Build macOS packages
        id: build-packages
        uses: love-actions/love-actions-macos-appstore@v1
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-appstore
          app-name: ${{ env.PRODUCT_NAME }}
          #apple-development-base64: ${{ secrets.APPLE_CERT_APPLE_DEVELOPMENT_BASE64 }}
          #apple-development-password: ${{ secrets.APPLE_CERT_APPLE_DEVELOPMENT_PWD }}
          #api-key: ${{ secrets.APPLE_API_KEY }}
          #api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
          #api-issuer-id: ${{ secrets.APPLE_API_ISSUER_ID }}
          #team-id: ${{ secrets.APPLE_DEVELOPER_TEAM_ID }}
          #apple-id: ${{ secrets.APPLE_APPLE_ID }}
          bundle-id: ${{ env.PRODUCT_ID }}
          copyright: ${{ env.PRODUCT_COPYRIGHT }}
          icon-path: ${{ env.OUTPUT_FOLDER }}/icon.icns
          #libs-path: ./ColdClear/universal/
          external-test: ${{ startsWith(github.ref, 'refs/tags/pre') }}
          store-release: ${{ startsWith(github.ref, 'refs/tags/v') }}
          version-string: ${{ env.PRODUCT_VERSION }}
      - name: Upload logs artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_macOS_appstore_logs
          path: |
            ${{ env.OUTPUT_FOLDER }}/DistributionSummary.plist
            ${{ env.OUTPUT_FOLDER }}/ExportOptions.plist
            ${{ env.OUTPUT_FOLDER }}/Packaging.log
      - name: Upload pkg artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_macOS_appstore_pkg
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}-appstore.pkg

  build-ios:
    runs-on: macos-latest
    needs: [configure]
    env:
      BUILD_NUM: ${{ needs.configure.outputs.build_num }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Build love package
        run: ./tools/build-love.sh "${{ env.PRODUCT_NAME }}"
      - name: Convert iOS icns
        run: |
          mkdir -p ${{ env.OUTPUT_FOLDER }}/icns
          sips -z 180 180   ./resources/icon.png --out ${{ env.OUTPUT_FOLDER }}/icns/icon-60@3x.png
          sips -z 120 120   ./resources/icon.png --out ${{ env.OUTPUT_FOLDER }}/icns/icon-60@2x.png
          sips -z 167 167   ./resources/icon.png --out ${{ env.OUTPUT_FOLDER }}/icns/icon-83.5@2x.png
          sips -z 152 152   ./resources/icon.png --out ${{ env.OUTPUT_FOLDER }}/icns/icon-76@2x.png
          sips -z 1024 1024 ./resources/icon.png --out ${{ env.OUTPUT_FOLDER }}/icns/icon-1024.png
      - name: Build iOS packages
        id: build-packages
        uses: love-actions/love-actions-ios@v1
        with:
          love-package: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}.love
          output-folder: ${{ env.OUTPUT_FOLDER }}
          product-name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}
          app-name: ${{ env.PRODUCT_NAME }}
          #apple-development-base64: ${{ secrets.APPLE_CERT_APPLE_DEVELOPMENT_BASE64 }}
          #apple-development-password: ${{ secrets.APPLE_CERT_APPLE_DEVELOPMENT_PWD }}
          #api-key: ${{ secrets.APPLE_API_KEY }}
          #api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
          #api-issuer-id: ${{ secrets.APPLE_API_ISSUER_ID }}
          #team-id: ${{ secrets.APPLE_DEVELOPER_TEAM_ID }}
          #apple-id: ${{ secrets.APPLE_APPLE_ID }}
          bundle-id: ${{ env.PRODUCT_ID }}
          copyright: ${{ env.PRODUCT_COPYRIGHT }}
          icon-path: ${{ env.OUTPUT_FOLDER }}/icns
          #libs-path: ./ColdClear/arm64/
          #love-patch: ./.github/build/iOS/love.patch
          external-test: ${{ startsWith(github.ref, 'refs/tags/pre') }}
          store-release: ${{ startsWith(github.ref, 'refs/tags/v') }}
          version-string: ${{ env.PRODUCT_VERSION }}
      - name: Upload logs artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_iOS_logs
          path: |
            ${{ env.OUTPUT_FOLDER }}/DistributionSummary.plist
            ${{ env.OUTPUT_FOLDER }}/ExportOptions.plist
            ${{ env.OUTPUT_FOLDER }}/Packaging.log
      - name: Upload ipa artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}_iOS_ipa
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.PRODUCT_NAME }}-${{ env.BUILD_NUM }}.ipa
